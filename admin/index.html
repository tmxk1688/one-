<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <style>
      /* 简单的加载样式 */
      .loading {
        text-align: center;
        padding: 40px;
        font-family: Arial, sans-serif;
        color: #333;
      }
      
      .error {
        text-align: center;
        padding: 40px;
        font-family: Arial, sans-serif;
        color: #ff4444;
      }
      
      .instructions {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background: #f5f5f5;
        border-radius: 8px;
        font-family: Arial, sans-serif;
        line-height: 1.6;
      }
      
      .instructions h2 {
        color: #0066cc;
      }
      
      .instructions code {
        background: #e0e0e0;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <!-- 加载状态 -->
    <div id="loading" class="loading">
      <h1>正在加载内容管理系统...</h1>
      <p>请稍候...</p>
    </div>
    
    <!-- 错误信息 -->
    <div id="error" class="error" style="display: none;">
      <h1>加载失败</h1>
      <p>无法加载内容管理系统，请检查以下问题：</p>
      <ul style="text-align: left; max-width: 500px; margin: 20px auto;">
        <li>确保通过HTTP/HTTPS访问，而不是直接打开本地文件</li>
        <li>检查浏览器控制台获取详细错误信息</li>
        <li>确保所有脚本正确加载</li>
      </ul>
      <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer;">
        重试
      </button>
    </div>
    
    <!-- Decap CMS 脚本 -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    
    <!-- 自定义CMS配置 -->
    <script>
      // 确保DOM加载完成后执行
      document.addEventListener('DOMContentLoaded', function() {
        try {
          // 检查DecapCMS是否加载成功
          if (typeof DecapCMS === 'undefined') {
            throw new Error('DecapCMS 脚本未正确加载');
          }
          
          console.log('DecapCMS 脚本已加载');
          
          // 初始化CMS，使用完整配置，不依赖外部config.yml
          DecapCMS.init({
            config: {
              backend: {
                name: 'github',
                repo: 'tmxk1688/one-',
                branch: 'main',
                auth_type: 'pkce',
                base_url: 'https://github.com',
                app_id: 'Ov23liMVe0P8Zf9PeTb5'
              },
              media_folder: 'static/uploads',
              public_folder: '/uploads',
              collections: [
                {
                  name: 'news',
                  label: '新闻',
                  folder: 'content/news',
                  create: true,
                  slug: '{{slug}}',
                  fields: [
                    { label: '标题', name: 'title', widget: 'string' },
                    { label: '发布日期', name: 'date', widget: 'datetime' },
                    { label: '作者', name: 'author', widget: 'string' },
                    { label: '摘要', name: 'excerpt', widget: 'text' },
                    { label: '内容', name: 'body', widget: 'markdown' },
                    { label: '封面图', name: 'cover_image', widget: 'image', required: false }
                  ]
                }
              ]
            }
          });
          
          // 隐藏加载状态
          document.getElementById('loading').style.display = 'none';
          
          console.log('Decap CMS 配置已加载');
          console.log('当前配置:', {
            repo: 'tmxk1688/one-',
            auth_type: 'pkce',
            branch: 'main',
            base_url: 'https://github.com',
            app_id: 'Ov23liMVe0P8Zf9PeTb5'
          });
          
        } catch (error) {
          console.error('CMS 初始化失败:', error);
          
          // 显示错误信息
          document.getElementById('loading').style.display = 'none';
          document.getElementById('error').style.display = 'block';
        }
      });
    </script>
    
    <!-- 配置说明 -->
    <div class="instructions">
      <h2>配置说明</h2>
      <p><strong>重要提示：确保GitHub OAuth App配置正确</strong></p>
      <ol>
        <li>
          <strong>在GitHub更新OAuth App设置</strong>
          <ul>
            <li>访问：GitHub Settings → Developer settings → OAuth Apps</li>
            <li>找到已创建的OAuth App："天马行空创意网 CMS"</li>
            <li>点击"Edit"</li>
            <li>确保以下配置正确：
              <ul>
                <li>Homepage URL: <code>https://tmxkcy.xyz</code></li>
                <li>Authorization callback URL: <code>https://tmxkcy.xyz/admin/</code> （必须与CMS访问URL完全一致）</li>
              </ul>
            </li>
            <li>点击"Update application"保存</li>
          </ul>
        </li>
        <li>
          <strong>验证Client ID是否正确</strong>
          <ul>
            <li>当前使用的Client ID：<code>Ov23liMVe0P8Zf9PeTb5</code></li>
            <li>确保与GitHub OAuth App中的Client ID完全一致</li>
          </ul>
        </li>
        <li>
          <strong>使用HTTP服务器访问</strong>
          <ul>
            <li>不要直接打开本地文件（file://协议）</li>
            <li>使用本地HTTP服务器：<code>npx http-server -p 8080</code></li>
            <li>然后访问：<code>http://localhost:8080/admin/</code></li>
          </ul>
        </li>
      </ol>
    </div>
  </body>
</html>